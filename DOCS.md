# Race Vision — Документация

## Как работает система

### Общая схема

```
Аналитические камеры (RTSP/видео)        PTZ камеры (вещание)
         |                                       |
   api/server.py                           PublicDisplay
   (YOLO + CNN детекция)                  (зрители видят чистый эфир)
         |                                       |
         +--- MJPEG /stream/cam{N} ---> CameraGrid (только оператор)
         |
         +--- WebSocket /ws ----------> Фронтенд (React)
              (позиции, ранкинги)           |
                                     OperatorPanel + PublicDisplay
                                     (анимированные иконки жокеев)
```

### Два типа камер

| Тип | Назначение | Где видно | Конфиг |
|-----|-----------|-----------|--------|
| **Аналитические** | YOLO + CNN детекция жокеев | CameraGrid (оператор) | `ANALYTICS_CAMERAS` |
| **PTZ** | Трансляция для зрителей | PublicDisplay | `PTZ_CAMERAS` |

**Строгое разделение:** аналитическое видео никогда не показывается зрителям. PublicDisplay получает только данные о позициях (через WebSocket), а видеопоток — только от PTZ камер. Если PTZ камеры не подключены — зрители видят чёрный фон + иконки жокеев.

### Поток данных

1. Бэкенд читает видеопотоки из аналитических камер (RTSP или видеофайлы)
2. На каждом кадре — детекция жокеев (YOLO + цветовой классификатор)
3. Определяются позиции (кто впереди, кто сзади) через голосование
4. Результат отправляется на фронтенд через WebSocket
5. CameraGrid показывает аннотированное видео (MJPEG) с bbox и подписями
6. PublicDisplay показывает PTZ камеру + анимированные иконки жокеев

---

## Цвета и жокеи

Система распознаёт **5 цветов** жокейской формы:

| Цвет | ID | Иконка | Имя в системе | HEX |
|------|----|--------|---------------|-----|
| Красный | horse-1 | `silk_1.svg` | Red Runner | #DC2626 |
| Синий | horse-2 | `silk_2.svg` | Blue Storm | #2563EB |
| Зелёный | horse-3 | `silk_3.svg` | Green Flash | #16A34A |
| Жёлтый | horse-4 | `silk_4.svg` | Yellow Thunder | #FBBF24 |
| Фиолетовый | horse-5 | `silk_5.svg` | Purple Reign | #9333EA |

SVG файлы находятся в `Kabirhan-Frontend/public/assets/silks/`.

---

## Конфигурация камер

Файл: `Kabirhan-Frontend/src/config/cameras.ts`

### Аналитические камеры (ANALYTICS_CAMERAS)

3 камеры для детекции. Каждая покрывает свой участок трассы:

| ID | Участок | RTSP |
|----|---------|------|
| analytics-1 | 0–100 м | `rtsp://...101:554/stream` |
| analytics-2 | 100–200 м | `rtsp://...102:554/stream` |
| analytics-3 | 200–300 м | `rtsp://...103:554/stream` |

Видео с этих камер показывается **только** в CameraGrid оператора через MJPEG потоки `/stream/cam{1-3}`.

### PTZ камеры (PTZ_CAMERAS)

3 камеры для трансляции. По умолчанию `mjpegUrl: ''` (не подключены):

| ID | Позиция | Статус |
|----|---------|--------|
| ptz-1 | 0 м | offline |
| ptz-2 | 100 м | offline |
| ptz-3 | 200 м | offline |

Когда PTZ камера подключена, оператор прописывает `mjpegUrl` и видео появляется на PublicDisplay.

---

## Детекция: как определяются позиции

### Путь: Камера → Цвет → Иконка

```
Кадр видео
  → YOLO находит людей (bounding box)
  → Вырезается торс (верхние 45% bbox)
  → CNN классификатор определяет цвет: "red", "blue", "green", "yellow", "purple"
  → Бэкенд маппит цвет на жокея:
      "red"    → silkId: 1 → silk_1.svg
      "blue"   → silkId: 2 → silk_2.svg
      "green"  → silkId: 3 → silk_3.svg
      "yellow" → silkId: 4 → silk_4.svg
      "purple" → silkId: 5 → silk_5.svg
  → Фронтенд получает silkId и загружает SVG:
      /assets/silks/silk_{silkId}.svg
```

### 4-уровневая фильтрация

Каждая детекция проходит 4 фильтра:

**F1 — Уверенность классификатора (conf >= 0.75)**
Если CNN не уверен в цвете, детекция отбрасывается.

**F2 — Согласие CNN и HSV**
CNN предсказывает цвет по нейросети, HSV — по цветовому пространству.
Если они не совпадают — детекция отбрасывается.
Исключение: если CNN уверен на 92%+, HSV проверка пропускается.

**F3 — Ограничение скорости (макс. 120 м/с)**
Если между кадрами позиция прыгнула слишком далеко — ложное срабатывание.

**F4 — Временное подтверждение (2 из 5 кадров)**
Цвет должен быть замечен минимум 2 раза за последние 5 кадров.

### Голосование по видео

```
Видео 1 (cam1) проигрывается
  → На каждом кадре: детекция → фильтрация
  → Если после фильтрации видны 4+ цветов:
      сортировка по X (правее = впереди)
      этот порядок = 1 голос
  → Видео закончилось:
      подсчёт голосов
      самый частый порядок = результат
      отправка на фронтенд → иконки перемещаются
Видео 2 (cam2) начинается...
```

Пример голосования:
```
Кадр 10: PUR > RED > BLU > YEL > GRE  — 1 голос
Кадр 15: PUR > RED > BLU > YEL > GRE  — 2 голоса
Кадр 20: RED > PUR > BLU > YEL > GRE  — 1 голос
Кадр 25: PUR > RED > BLU > YEL > GRE  — 3 голоса

Результат: PUR > RED > BLU > YEL > GRE (3 голоса из 4)
```

### Правило: 1 видео = 1 переход

- Во время проигрывания видео порядок на фронтенде **не меняется**
- Только когда видео закончилось — выбирается лучший результат и отправляется
- Это даёт стабильную картинку без дёргания

---

## WebSocket протокол

### Бэкенд → Фронтенд

**При подключении — список жокеев:**
```json
{
  "type": "horses_detected",
  "horses": [
    {
      "id": "horse-1",
      "number": 1,
      "name": "Red Runner",
      "color": "#DC2626",
      "jockeyName": "Jockey 1",
      "silkId": 1
    }
  ]
}
```

**Старт гонки:**
```json
{
  "type": "race_start",
  "race": {
    "name": "Race",
    "totalLaps": 1,
    "trackLength": 2500,
    "status": "racing"
  }
}
```

**Обновление позиций (каждые 200 мс):**
```json
{
  "type": "ranking_update",
  "rankings": [
    {
      "id": "horse-5",
      "number": 5,
      "name": "Purple Reign",
      "silkId": 5,
      "position": 1,
      "distanceCovered": 1850.5,
      "gapToLeader": 0,
      "speed": 0,
      "currentLap": 1
    },
    {
      "id": "horse-1",
      "number": 1,
      "name": "Red Runner",
      "silkId": 1,
      "position": 2,
      "distanceCovered": 1780.2,
      "gapToLeader": 1.5,
      "speed": 0,
      "currentLap": 1
    }
  ]
}
```

**Переключение камеры:**
```json
{"type": "camera_switch", "cameraId": "ptz-2"}
```

### Фронтенд → Бэкенд

| Сообщение | Описание |
|-----------|----------|
| `{"type": "ping"}` | Проверка соединения (каждые 5 сек) |
| `{"type": "get_state"}` | Запрос текущего состояния |
| `{"type": "start_race"}` | Старт гонки (из панели оператора) |
| `{"type": "stop_race"}` | Остановка гонки |

---

## MJPEG видеопотоки

Бэкенд отдаёт аннотированное видео (с bbox и подписями цветов) по HTTP.
**Каждая камера — отдельный поток:**

| URL | Камера | Описание |
|-----|--------|----------|
| `http://localhost:8000/stream/cam1` | analytics-1 | Видео первой камеры |
| `http://localhost:8000/stream/cam2` | analytics-2 | Видео второй камеры |
| `http://localhost:8000/stream/cam3` | analytics-3 | Видео третьей камеры |

Формат: `multipart/x-mixed-replace` (стандартный MJPEG).

Видео проигрываются **последовательно** (cam1 → cam2 → cam3 → цикл), но каждое записывает аннотированные кадры в свой слот. Когда камера не активна — показывается последний кадр с надписью "Camera N — waiting...".

---

## Анимация на фронтенде

Когда позиции меняются, иконки жокеев анимируются:

- **Горизонтальное перемещение**: иконки плавно скользят на новые позиции (3 сек, tween)
- **Дуга вверх**: жокей обогнал → иконка прыгает вверх на 80px и возвращается
- **Дуга вниз**: жокей отстал → иконка опускается на 50px и возвращается
- **Подсветка**: зелёное свечение (drop-shadow) для обгона, красное для отставания
- **Стрелки**: ▲ +N (обогнал на N позиций), ▼ -N (отстал)
- Индикаторы держатся 10 секунд

---

## Параметры фильтрации

Настраиваются в `api/server.py`, класс `DetectionLoop`:

| Параметр | Значение | Описание |
|----------|----------|----------|
| `CONF_THRESHOLD` | 0.75 | Мин. уверенность классификатора |
| `HSV_SKIP_CONF` | 0.92 | При такой уверенности HSV-проверка пропускается |
| `MAX_SPEED_MPS` | 120.0 | Макс. скорость (м/с) для фильтра телепортации |
| `TEMPORAL_WINDOW` | 5 | Размер скользящего окна (кадров) |
| `TEMPORAL_MIN` | 2 | Мин. детекций в окне для подтверждения |

---

## Фронтенд: страницы и компоненты

### Страницы

| URL | Компонент | Назначение |
|-----|-----------|------------|
| `/` | `PublicDisplay` | Экран для зрителей: PTZ видео + панель с иконками жокеев |
| `/operator` | `OperatorPanel` | Панель оператора: камеры, трек, настройки |

### Компоненты оператора

| Компонент | Описание |
|-----------|----------|
| `CameraGrid` | Сетка аналитических камер (3 шт.) с MJPEG превью |
| `CameraSettings` | Настройка камер (аналитика + PTZ) |
| `PTZControlPanel` | Выбор и превью PTZ камер |
| `Track2DView` | 2D овал трассы с позициями камер и лошадей |
| `RaceSettings` | Форма настроек гонки |

### Компоненты публичного экрана

| Компонент | Описание |
|-----------|----------|
| `PTZCameraDisplay` | Видео с активной PTZ камеры (или заглушка) |
| `RankingBoard` | Таблица результатов |

### Хранилища (Zustand)

| Store | Ключевые данные |
|-------|----------------|
| `raceStore` | `race` (статус, лапы), `horses`, `rankings`, `backendConnected` |
| `cameraStore` | `analyticsCameras`, `ptzCameras`, `activePTZCameraId` |

---

## Запуск

### Бэкенд

```bash
# Видеофайлы (последовательный цикл)
.venv\Scripts\python.exe api/server.py --video data/videos/exp10_cam1.mp4 data/videos/exp10_cam2.mp4 data/videos/exp10_cam3.mp4 --auto-start

# RTSP с GPU декодером
.venv\Scripts\python.exe api/server.py --url "rtsp://admin:pass@192.168.1.100:554/stream" --gpu
```

Аргументы:

| Аргумент | По умолчанию | Описание |
|----------|-------------|----------|
| `--url` | `rtsp://...` | URL RTSP потока |
| `--video` | — | Видеофайлы (проигрываются последовательно) |
| `--gpu` | выкл | GPU декодирование (hevc_cuvid) |
| `--host` | `0.0.0.0` | Хост сервера |
| `--port` | `8000` | Порт сервера |
| `--auto-start` | выкл | Автостарт гонки при запуске |

### Фронтенд

```bash
cd Kabirhan-Frontend
npm install
npm run dev
```

### Проверка

1. `http://localhost:8000/stream/cam1` — MJPEG поток с детекцией (cam1)
2. `http://localhost:5173/operator` — панель оператора (камеры + трек)
3. `http://localhost:5173/` — публичный экран (иконки жокеев)

---

## Требования

- Python 3.9+ с CUDA GPU
- Node.js 18+
- Зависимости Python: `pip install fastapi uvicorn[standard] ultralytics torch torchvision opencv-python`
- Зависимости фронтенда: `npm install` (React 19, Zustand 5, Framer Motion 12, Tailwind CSS 4)
