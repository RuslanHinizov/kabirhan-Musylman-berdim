# Race Vision — Система Отслеживания Позиций Скачек в Реальном Времени

Система отслеживания позиций и трансляции скачек в реальном времени. Обнаружение жокеев с помощью YOLOv8 + CNN и классификация цветов, профессиональная архитектура с 28 камерами, потоковая передача видео WebRTC с низкой задержкой и поддержка 4 языков.

---

## О Проекте

Race Vision — это комплексная система, которая определяет положение лошадей на ипподромах в режиме реального времени, ранжирует их и представляет в виде прямой трансляции.

- **YOLOv8s** для обнаружения жокеев/людей
- **SimpleColorCNN** (PyTorch) для классификации цветов жокеев (5 цветов)
- **Профессиональная архитектура из 28 камер** (25 аналитических + 3 PTZ)
- **WebRTC** потоковая передача видео с низкой задержкой (с MJPEG fallback)
- **Поддержка 4 языков**: Английский (EN), Турецкий (TR), Русский (RU), Казаxский (KK)
- **GPU-ускорение** декодирования/кодирования видео (NVDEC/NVENC)
- Два отдельных интерфейса: панель оператора и публичный экран

---

## Технологии

### Бэкенд

| Технология | Версия / Описание |
|-----------|---------------------|
| Python | 3.10+ |
| FastAPI + Uvicorn | ASGI веб-фреймворк |
| YOLOv8s (Ultralytics) | Обнаружение жокеев/людей |
| SimpleColorCNN (PyTorch) | Классификация цветов жокеев (5 цветов: красный, синий, зеленый, желтый, фиолетовый) |
| OpenCV | Обработка видео |
| aiortc | Потоковая передача WebRTC |
| NVDEC/NVENC | GPU-ускорение декодирования/кодирования видео |

### Фронтенд

| Технология | Версия / Описание |
|-----------|---------------------|
| React | 19.2 |
| TypeScript | 5.9 |
| Vite | 7.2 (инструмент сборки) |
| Zustand | 5 (управление состоянием) |
| Framer Motion | 12 (анимации) |
| Tailwind CSS | 4 (стилизация) |
| i18next | Поддержка 4 языков (EN/TR/RU/KK) |
| lucide-react | Библиотека иконов |

---

## Архитектура

### Роли Камер

#### 25 Аналитических Камер (analytics-1 — analytics-25)

- Каждая камера покрывает сегмент трассы длиной **100 м** (всего **2500 м**)
- Выполняется обнаружение YOLO + ColorCNN
- Зрители **НЕ ВИДЯТ** эти камеры
- На фронтенд отправляются только данные ранжирования
- Для эффективного использования ресурсов GPU применяется интеллектуальная приоритизация

#### 3 PTZ Камеры (ptz-1, ptz-2, ptz-3)

- Только **камеры трансляции** — экран, который видят зрители
- Обнаружение **НЕ ВЫПОЛНЯЕТСЯ** (для производительности)
- Плавный высокий FPS, низкая задержка
- Позиции:
  - `ptz-1`: 0м (старт)
  - `ptz-2`: 1250м (середина)
  - `ptz-3`: 2500м (финиш)

### Поток Данных

```
25 RTSP Камер --> Потоки CameraReader --> MultiCameraManager
                                                  |
                                                  v
SmartDetectionScheduler --> MultiDetectionLoop --> состояние на камеру
                                                  |
                                                  v
RankingMerger --> объединенное ранжирование --> WebSocket broadcast
                                                  |
                                                  v
Потоки WebRTC/MJPEG --> Фронтенд (оператор + публичный экран)
```

**Пошаговый поток:**

1. 25 аналитических камер подключены к потокам `CameraReader` через RTSP
2. `MultiCameraManager` управляет потоками всех камер
3. `SmartDetectionScheduler` определяет, как часто должны обрабатываться камеры
4. `MultiDetectionLoop` запускает YOLO + CNN на выбранных камерах в каждом цикле
5. `RankingMerger` объединяет данные со всех камер и создает единый рейтинг в диапазоне 0-2500м
6. Данные о рейтинге транслируются всем клиентам через WebSocket
7. PTZ-камеры передают живое изображение через WebRTC (или MJPEG fallback)

---

## Интеллектуальная Приоритизация Обнаружения

Система использует трехуровневый механизм приоритизации для эффективного использования ресурсов GPU:

| Уровень | FPS | Условие | Описание |
|--------|-----|-------|----------|
| **HIGH** | 10 fps | Камеры, где обнаружена лошадь | Максимальная скорость обработки |
| **LOW** | 2 fps | Лошадь на соседних камерах | Режим подготовки |
| **IDLE** | 0.5 fps | Лошадь отсутствует | Режим сканирования |

**Правила:**
- Максимум **5 камер** обрабатываются за цикл (бюджет GPU)
- Передача лошади: при достижении **85%** кадра инициируется переход на следующую камеру
- Приоритизация пересчитывается в начале каждого цикла

---

## 4-Уровневая Фильтрация

Для надежности результатов обнаружения применяется четырехуровневая система фильтрации:

1. **Временной фильтр** — Требуется обнаружение минимум 3 раза за последние 5 кадров (снижение шума)
2. **Сглаживание EMA** — Сглаживание позиции (alpha=0.3), предотвращаются резкие скачки
3. **Фильтр скорости** — Отклоняет физически невозможные скорости (предотвращение телепортации)
4. **Живое голосование** — Извлекает надежный результат из множественных обнаружений

Эти уровни применяются последовательно, и только результаты, прошедшие все фильтры, отражаются в таблице рейтинга.

---

## Таблица Соответствия Цвет - Лошадь

Жилеты жокеев классифицируются по цвету, и каждый цвет соответствует определенной лошади:

| Цвет | ID Лошади | Номер | Имя | ID Жилета |
|------|-------|--------|----|---------|
| Красный | horse-1 | 1 | Red Runner | 1 |
| Синий | horse-2 | 2 | Blue Storm | 2 |
| Зеленый | horse-3 | 3 | Green Flash | 3 |
| Желтый | horse-4 | 4 | Yellow Thunder | 4 |
| Фиолетовый | horse-5 | 5 | Purple Reign | 5 |

**Процесс классификации:**
1. YOLO обнаруживает человека/жокея и выделяет bounding box
2. Изображение внутри bounding box обрезается (crop)
3. SimpleColorCNN присваивает этому изображению один из 5 классов цвета
4. Личность лошади определяется по таблице соответствия цвет-лошадь

---

## Установка

### Требования

- Python 3.10+
- Node.js 18+
- NVIDIA GPU (поддержка CUDA, опционально, но рекомендуется)
- FFmpeg (для декодирования RTSP)

### Установка Бэкенда

```bash
cd race_vision
python -m venv .venv
.venv\Scripts\activate  # Windows
pip install -r requirements.txt
```

> **Примечание:** Для ускорения GPU должны быть установлены NVIDIA CUDA Toolkit и совместимая версия PyTorch.

### Установка Фронтенда

```bash
cd Kabirhan-Frontend
npm install
```

---

## Запуск

### Режим Видео-Теста (разработка)

Для тестирования с записанными видео без реальной камеры:

```bash
python api/server.py --video video/exp10_cam1.mp4 video/exp10_cam2.mp4 video/exp10_cam3.mp4 --auto-start
```

- `--video`: Указывает пути к тестовым видеофайлам
- `--auto-start`: Автоматически запускает обнаружение при старте сервера

### Режим Реальной RTSP Камеры

```bash
python api/server.py --gpu
```

После запуска сервера настройте URL-адреса камер в панели оператора:

1. Перейдите по адресу `http://localhost:5173/operator`
2. Перейдите на вкладку **RTSP Cameras**
3. Введите RTSP URL для каждой камеры
4. Запустите камеры по одной или все вместе

### Фронтенд

```bash
cd Kabirhan-Frontend
npm run dev
```

Адреса доступа:

| Страница | URL | Описание |
|-------|-----|----------|
| Панель Оператора | `http://localhost:5173/operator` | Управление камерами, контроль гонки, 2D вид трассы |
| Публичный Экран | `http://localhost:5173/` | Изображение с PTZ-камеры + таблица рейтинга |

---

## API Эндпоинты

### REST API

| Метод | Эндпоинт | Описание |
|--------|----------|----------|
| `PUT` | `/api/cameras/{id}` | Обновить RTSP URL камеры |
| `POST` | `/api/cameras/{id}/start` | Запустить определенную камеру |
| `POST` | `/api/cameras/{id}/stop` | Остановить определенную камеру |
| `GET` | `/api/streams/status` | Получить статусы всех камер |
| `POST` | `/api/cameras/start-all` | Запустить все камеры |
| `POST` | `/api/cameras/stop-all` | Остановить все камеры |
| `GET` | `/api/system/health` | Проверка состояния системы |

### WebSocket

- **Подключение:** `ws://localhost:8000/ws`
- **Типы сообщений:**

| Тип Сообщения | Направление | Описание |
|------------|-----|----------|
| `ranking_update` | Сервер -> Клиент | Актуальные данные рейтинга |
| `camera_detection` | Сервер -> Клиент | Результаты обнаружения по камерам |
| `race_start` | Сервер -> Клиент | Информация о начале гонки |
| `race_stop` | Сервер -> Клиент | Информация об окончании гонки |
| `horses_detected` | Сервер -> Клиент | Обнаруженные лошади |
| `pong` | Сервер -> Клиент | Ответ Heartbeat |
| `state` | Сервер -> Клиент | Полная синхронизация состояния |

### Потоковая Передача Видео (Video Streaming)

| Эндпоинт | Описание |
|----------|----------|
| `GET /stream/cam{N}` | Поток MJPEG (N=1-25 аналитические камеры) |
| `GET /stream/{cam_id}` | Поток MJPEG (формат cam_id, например `analytics-1`) |
| `POST /api/webrtc/offer` | Обмен WebRTC SDP offer/answer |
| `GET /api/webrtc/status` | Статус подключения WebRTC |

**Стратегия потоковой передачи видео:**
- Сначала пробуется подключение WebRTC (низкая задержка)
- Если WebRTC не удается, автоматически переключается на MJPEG (fallback)
- `WebRTCPlayer.tsx` и `MJPEGPlayer.tsx` управляют этим переходом прозрачно

---

## Структура Файлов

```
race_vision/
|
|-- api/
|   |-- server.py                # Основной сервер FastAPI (~940 строк)
|   |-- camera_manager.py        # CameraReader + MultiCameraManager (~480 строк)
|   |-- smart_detection.py       # SmartDetectionScheduler (~300 строк)
|   |-- ranking_merger.py        # RankingMerger (~200 строк)
|   |-- webrtc_server.py         # WebRTC streaming (~180 строк)
|   +-- __init__.py
|
|-- Kabirhan-Frontend/
|   |-- src/
|   |   |-- pages/
|   |   |   |-- OperatorPanel.tsx      # Контрольная панель оператора
|   |   |   +-- PublicDisplay.tsx      # Публичный экран
|   |   |
|   |   |-- components/
|   |   |   |-- WebRTCPlayer.tsx       # Видеоплеер WebRTC
|   |   |   |-- MJPEGPlayer.tsx        # Плеер MJPEG fallback
|   |   |   |-- LanguageSelector.tsx   # Выбор языка
|   |   |   |
|   |   |   |-- operator/
|   |   |   |   |-- CameraGrid.tsx         # Вид сетки 25 камер
|   |   |   |   |-- CameraSettings.tsx     # Настройки RTSP камер
|   |   |   |   |-- PTZControlPanel.tsx    # Выбор PTZ камеры
|   |   |   |   |-- Track2DView.tsx        # Вид овальной трассы 2D
|   |   |   |   +-- RaceSettings.tsx       # Настройки гонки
|   |   |   |
|   |   |   +-- public-display/
|   |   |       |-- PTZCameraDisplay.tsx   # Изображение PTZ камеры
|   |   |       +-- RankingBoard.tsx       # Таблица рейтинга
|   |   |
|   |   |-- store/
|   |   |   |-- cameraStore.ts     # Состояние камеры (Zustand)
|   |   |   +-- raceStore.ts       # Состояние гонки (Zustand)
|   |   |
|   |   |-- services/
|   |   |   +-- backendConnection.ts  # Клиент WebSocket
|   |   |
|   |   |-- config/
|   |   |   +-- cameras.ts         # Конфигурация камер
|   |   |
|   |   |-- i18n/
|   |   |   |-- index.ts           # Инициализация i18next
|   |   |   +-- locales/
|   |   |       |-- en.ts          # Английский
|   |   |       |-- tr.ts          # Турецкий
|   |   |       |-- ru.ts          # Русский
|   |   |       +-- kk.ts          # Казахский
|   |   |
|   |   |-- utils/
|   |   |   +-- silkUtils.ts       # Помощники иконок Silk/жокеев
|   |   |
|   |   +-- types/
|   |       +-- index.ts           # Типы TypeScript
|   |
|   +-- public/
|       +-- assets/silks/          # 10 иконок жокейских жилетов SVG
|
|-- models/
|   +-- color_classifier.pt       # Обученная модель CNN для цвета (2.5MB)
|
|-- tools/
|   |-- test_race_count.py         # RaceTracker + ColorClassifier
|   |-- test_rtsp.py               # FFmpegReader (GPU decode)
|   +-- train_color_classifier.py  # Скрипт обучения CNN
|
|-- video/                         # Тестовые видео (3 MP4)
|-- yolov8s.pt                     # Модель YOLOv8s (22.5MB)
|-- requirements.txt               # Зависимости Python
```

---

## Поддержка Языков

| Язык | Код | Файл |
|-----|-----|-------|
| Английский | EN | `src/i18n/locales/en.ts` |
| Турецкий | TR | `src/i18n/locales/tr.ts` |
| Русский | RU | `src/i18n/locales/ru.ts` |
| Казахский | KK | `src/i18n/locales/kk.ts` |

**Поведение:**
- Язык браузера определяется автоматически и загружается соответствующий перевод
- Выбор пользователя сохраняется в `localStorage`
- Синхронизируется между вкладками
- Язык по умолчанию: Английский (EN)

---

## Использование Ресурсов GPU

Система использует различные аппаратные движки NVIDIA GPU параллельно:

| Модуль | Использование | Описание |
|-------|----------|----------|
| **NVDEC** | Декодирование 28 одновременных видеопотоков | Отдельный аппаратный движок, независимый от CPU |
| **CUDA** | Инференс YOLO + CNN | 3-5 камер обрабатываются за цикл |
| **NVENC** | Кодирование H.264 WebRTC | Отдельный аппаратный движок, независимый от CUDA |

**Потребление ресурсов:**
- Всего около **600-900MB VRAM**
- Комфортно работает на GPU с 6GB+ VRAM
- NVDEC и NVENC являются отдельными аппаратными движками, поэтому не влияют на инференс CUDA

---

## Детали Основных Компонентов

### server.py (Главный Сервер)

Точка входа приложения FastAPI. Содержит все REST эндпоинты, управление WebSocket и циклы обнаружения. Поддерживает режим видео-теста и режим RTSP. Около 940 строк.

### camera_manager.py

- **CameraReader**: Чтение RTSP/видео в отдельном потоке для каждой камеры
- **MultiCameraManager**: Управляет жизненным циклом потоков 28 камер
- Буфер кадров и механизм безопасной очереди потоков

### smart_detection.py

- **CameraDetectionState**: Хранит состояние отслеживания каждой камеры (HIGH/LOW/IDLE)
- **SmartDetectionScheduler**: Планирует, какие камеры и как часто нужно обрабатывать
- Логика передачи лошади и протокол связи соседних камер

### ranking_merger.py

- **RankingMerger**: Объединяет данные обнаружения с 25 аналитических камер
- Создает единый рейтинг в диапазоне 0-2500м
- Разрешает конфликтующие обнаружения и создает последовательный рейтинг

### webrtc_server.py

- Сервер WebRTC на базе **aiortc**
- Протокол SDP offer/answer
- Механизм MJPEG fallback
- Кодирование H.264 с ускорением GPU (NVENC)

### WebRTCPlayer.tsx

- Управление подключением WebRTC
- Автоматическое переподключение
- При неудаче переключается на `MJPEGPlayer.tsx` (fallback)

### Track2DView.tsx

- Вид овальной трассы 2D
- Показывает положение лошадей в реальном времени
- Отмечает позиции 25 аналитических камер
- Живые анимации (Framer Motion)

### RankingBoard.tsx

- Таблица рейтинга
- Визуальная идентификация лошади с иконками жокейских жилетов
- Обновление в реальном времени через WebSocket
- Поддержка 4 языков

---

## Функции Панели Оператора

Панель оператора (`/operator`) состоит из следующих компонентов:

1. **CameraGrid** — Сетка превью 25 аналитических камер
2. **CameraSettings** — Настройка RTSP URL, запуск/остановка камеры
3. **PTZControlPanel** — Выбор и просмотр 3 PTZ камер
4. **Track2DView** — Положение лошадей на овальной трассе в реальном времени
5. **RaceSettings** — Запуск/остановка гонки, сброс рейтинга

---

## Функции Публичного Экрана

Публичный экран (`/`) состоит из следующих компонентов:

1. **PTZCameraDisplay** — Полноэкранное живое изображение выбранной PTZ камеры
2. **RankingBoard** — Таблица рейтинга в реальном времени с иконками жилетов
3. **LanguageSelector** — Переключение между 4 языками

---

## Управление Состоянием (State Management)

### cameraStore.ts (Zustand)

- Состояние всех камер (подключено/не подключено, активно/пассивно)
- Предпочтение режима потока: `webrtc` или `mjpeg`
- ID камер в строковом формате: `analytics-1`, `ptz-1` и т.д.
- Использует строковые ключи `cam_id` для SharedState (не целочисленный индекс)

### raceStore.ts (Zustand)

- Статус гонки (не началась/идет/завершена)
- Данные рейтинга
- Позиции лошадей

### backendConnection.ts

- Управление подключением WebSocket
- Обработчики сообщений `camera_detection` и `ranking_update`
- Механизм автоматического переподключения
- Поддержка Heartbeat (ping/pong)
